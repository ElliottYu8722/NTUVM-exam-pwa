<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>獸醫師國考（PWA）</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000"/>
  <style>
    :root{
      --bg:#111; --fg:#fff; --muted:#aaa; --card:#1b1b1b; --border:#2a2a2a; --accent:#2f74ff;
      --btn:#222; --btn-fg:#fff; --pill:#2a2a2a;
    }
    body{margin:0;font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Noto Sans TC", Segoe UI, Roboto, Helvetica, Arial, "PingFang TC", "Heiti TC", "Microsoft JhengHei", sans-serif;background:var(--bg);color:var(--fg);}
    .light{--bg:#fff;--fg:#000;--card:#f7f7f8;--border:#e5e5e6;--muted:#666;--btn:#f1f1f1;--btn-fg:#000;--pill:#ececec;}
    .app{display:grid;grid-template-columns:240px 1fr 280px;gap:16px;min-height:100vh;align-items:start;padding:16px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    .left .group{display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
    .select, .btn, .checkbox{font-size:16px}
    .select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--pill);color:var(--fg)}
    .btn{padding:10px 14px;border-radius:9999px;border:1px solid var(--border);background:transparent;color:var(--fg);cursor:pointer}
    .btn:hover{border-color:var(--accent);color:var(--accent)}
    .checkbox{display:flex;align-items:center;gap:8px;color:var(--fg)}
    .center .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
    .badge{padding:6px 10px;border:1px solid var(--border);border-radius:9999px;background:transparent;color:var(--fg);font-size:14px}
    .question-card{border-radius:16px;border:1px solid var(--border);padding:16px;background:var(--card)}
    .qtext{font-size:18px;line-height:1.6}
    .qimg{margin-top:10px;max-width:100%;height:auto;border-radius:8px;border:1px solid var(--border)}
    .options{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .navrow{display:flex;gap:8px;align-items:center;margin-top:14px}
    .spacer{flex:1}
    .right .q-list{height:70vh;overflow:auto;border-radius:12px;border:1px solid var(--border);background:var(--card);padding:8px}
    .q-item{padding:8px 10px;border-radius:8px;cursor:pointer}
    .q-item.active{background:var(--accent);color:#fff}
    .notes{margin-top:14px}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px;align-items:center;border:1px solid var(--border);border-radius:10px;background:transparent;padding:6px}
    .toolbar .pill{padding:6px 10px;border-radius:9999px;border:1px solid var(--border);background:transparent;color:var(--fg);cursor:pointer;font-size:14px}
    .toolbar .pill.active{border-color:var(--accent);color:var(--accent)}
    .toolbar select, .toolbar input[type=color]{border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:8px;padding:6px 8px}
    .editor{border:1px solid var(--border);border-radius:12px;background:var(--card);min-height:180px;padding:12px;margin-top:8px;outline:none}
    .timer{font-weight:700}
    .footer-hint{margin-top:12px;color:var(--muted);font-size:12px;text-align:center}
    .color-palette{
      position:absolute;
      display:grid;
      grid-template-columns: repeat(5, 1fr); /* 5 個一行 → 3 行 = 15 色 */
      gap:6px;
      padding:6px;
      border-radius:8px;
      background:var(--card,#1b1b1b);
      border:1px solid var(--border,#2a2a2a);
      z-index:1000;
    }
    
    .color-palette.hidden{
      display:none;
    }
    
    .color-palette button{
      width:22px;
      height:22px;
      border-radius:9999px;
      border:1px solid rgba(255,255,255,.7);
      padding:0;
      cursor:pointer;
    }
    .hidden{display:none !important}
    /* mobile */
    .mobile-toggle-bar { display:none; }
    @media (max-width: 1100px){
      .app{grid-template-columns:1fr}
      .right{order:3}
    }
    @media (max-width: 768px) {
      /* 中間照樣撐滿 */
      .center.panel {
        flex: 1 1 100%;
        max-width: 100%;
      }
    
      /* 左右欄改成固定在左右側的抽屜，預設在螢幕外 */
      .left.panel,
      .right.panel {
        position: fixed;
        top: 0;
        bottom: 0;
        width: 80vw;
        max-width: 320px;
        z-index: 100001;
        background: var(--bg);
        box-shadow: 0 0 20px rgba(0,0,0,.6);
        overflow-y: auto;
        transition: transform .25s ease;
      }
    
      .left.panel {
        left: 0;
        transform: translateX(-100%);
      }
    
      .right.panel {
        right: 0;
        transform: translateX(100%);
      }
    
      /* 顯示抽屜的狀態（用 body 上的 class 控制） */
      body.show-left-panel .left.panel {
        transform: translateX(0);
      }
    
      body.show-right-panel .right.panel {
        transform: translateX(0);
      }
    
      /* 手機版才顯示的上方兩顆按鈕 */
      .mobile-toggle-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
    
      .mobile-toggle-btn {
        flex: 0 0 auto;
        padding: 6px 10px;
        border-radius: 9999px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--fg);
        font-size: 13px;
      }
    
      /* 手機時隱藏原本左欄（避免佔版面；真正內容用抽屜那個 fixed 元素顯示） */
      .app {
        grid-template-columns: 1fr;
      }
    }

  </style>
</head>
<body class="">
  <div class="app" id="app">
    <!-- 左：工具列 -->
    <aside class="left panel">
      <div class="group">
        <select id="yearSel" class="select">
          <option>109</option><option>110</option><option>111</option><option>112</option><option>113</option><option selected>114</option>
        </select>
        <select id="roundSel" class="select">
          <option selected>第一次</option><option>第二次</option>
        </select>
        <select id="subjectSel" class="select">
          <option value="獸醫病理學" selected>獸醫病理學</option>
          <option value="獸醫藥理學">獸醫藥理學</option>
          <option value="獸醫實驗診斷學">獸醫實驗診斷學</option>
          <option value="獸醫普通疾病學">獸醫普通疾病學</option>
          <option value="獸醫傳染病學">獸醫傳染病學</option>
          <option value="獸醫公共衛生學">獸醫公共衛生學</option>
        </select>
      </div>

      <label class="checkbox"><input id="showAns" type="checkbox">顯示答案</label>
      <button id="btnExam" class="btn">測驗模式</button>
      <button id="btnRecords" class="btn">作答紀錄</button>
      <button id="btnTheme" class="btn">深色 / 淺色</button>
      <div id="group-section" class="group" style="margin-bottom: 16px;">
        <div style="display:flex; justify-content:space-between; align-items:center; font-weight:bold; margin-bottom:6px;">
          <span>群組</span>
          <button id="add-group-btn" class="btn" style="padding:0 8px; font-weight:bold;">＋</button>
        </div>
        <ul id="group-list" style="list-style:none; padding-left:0; max-height:200px; overflow:auto; margin:0;"></ul>
        <button id="show-all-questions-btn" class="btn" style="margin-top:6px; width:100%;">顯示全部題目</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
      <div class="group">
        <input id="qFile" class="hidden" type="file" accept="application/json">
        <input id="aFile" class="hidden" type="file" accept="application/json">
      </div>
      <p style="color:var(--muted);font-size:12px;line-height:1.6">
        詳解會陸續新增，之後會慢慢把每一題補齊唷！！<br>
        特別感謝詳解群組的每一位成員一起幫忙整理！！
      </p>
    </aside>
    
    <!-- 中：題目＋筆記 -->
    <main class="center">
      <div class="mobile-toggle-bar">
        <button id="btnOpenLeft" class="mobile-toggle-btn">工具</button>
        <button id="btnOpenRight" class="mobile-toggle-btn">題號</button>
      </div>
      <div class="topbar">
        <span class="badge">科目：<span id="bSubj">獸醫病理學</span></span>
        <span class="badge">年份：<span id="bYear">114</span></span>
        <span class="badge">梯次：<span id="bRound">第一</span></span>
        <span class="badge timer hidden" id="timer">剩餘 60:00</span>
        <span class="badge hidden" id="reviewTag">回顧模式（僅看錯題）</span>
        <span class="spacer"></span>
        <button id="btnSubmit" class="btn hidden">提交測驗</button>
        <button id="btnClose" class="btn hidden">關閉測驗</button>
      </div>

      <div class="question-card">
        <div id="qNum" class="badge" style="margin-bottom:8px">第 1 題</div>
        <div id="qText" class="qtext">請先載入題目</div>
        <img id="qImg" class="qimg hidden" alt="">
        <div id="qOpts" class="options"></div>
        <div id="qExplain" class="qtext hidden"
             style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px;"></div>

        <div class="navrow">
          <button id="prev" class="btn">上一題</button>
          <button id="next" class="btn">下一題</button>
          <span class="spacer"></span>
          <button id="btnToggleAns" class="btn">切換顯示答案</button>
        </div>
      </div>
      <!-- 新增：留言區（題目下、筆記上） -->
      <div id="comments-section" class="panel" style="margin-top:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span style="font-weight:bold;">留言區</span>
          <span id="comments-count" style="font-size:12px;color:var(--muted);"></span>
        </div>
    
        <div id="comments-list"
             style="max-height:200px;overflow:auto;margin-bottom:8px;font-size:14px;">
          目前還沒有留言，成為第一個留言的人吧！
        </div>
    
        <form id="comment-form"
              style="display:flex;flex-direction:column;gap:6px;">
          <input id="comment-nickname"
                 class="select"
                 maxlength="20"
                 placeholder="暱稱" />
    
          <textarea id="comment-text"
                    class="select"
                    rows="3"
                    maxlength="500"
                    placeholder="留言內容"></textarea>
    
          <button type="submit" class="btn">送出留言</button>
        </form>
      </div>      
      
      <div class="notes">
        <div class="toolbar">
          <!-- 字級 -->
          <select id="fontSel">
            <option>12</option>
            <option>14</option>
            <option selected>16</option>
            <option>18</option>
            <option>20</option>
            <option>24</option>
            <option>28</option>
            <option>32</option>
          </select>
        
          <!-- 粗體 / 斜體 / 底線 -->
          <button class="pill" id="bBold"><b>B</b></button>
          <button class="pill" id="bItalic"><i>I</i></button>
          <button class="pill" id="bUnder"><u>U</u></button>
        
          <!-- 上標 / 下標 -->
          <button class="pill" id="bSub">x₂</button>
          <button class="pill" id="bSup">x²</button>
        
          <button class="pill" id="bFontColor">
            <span>字體顏色</span>
            <span>▾</span>
          </button>
          <!-- 自製顏色面板 -->
          <div id="fontColorPalette" class="color-palette hidden">
                        <!-- 第一行：基本 -->
            <button data-color="#ffffff" style="background:#ffffff;"></button>
            <button data-color="#000000" style="background:#000000;"></button>
            <button data-color="#d32f2f" style="background:#d32f2f;"></button>
            <button data-color="#1976d2" style="background:#1976d2;"></button>
            <button data-color="#388e3c" style="background:#388e3c;"></button>
            <!-- 第二行：偏亮一點 -->
            <button data-color="#fbc02d" style="background:#fbc02d;"></button>
            <button data-color="#f57c00" style="background:#f57c00;"></button>
            <button data-color="#7b1fa2" style="background:#7b1fa2;"></button>
            <button data-color="#0097a7" style="background:#0097a7;"></button>
            <button data-color="#5d4037" style="background:#5d4037;"></button>
            <!-- 第三行：淡色系 -->
            <button data-color="#e0e0e0" style="background:#e0e0e0;"></button>
            <button data-color="#ffccbc" style="background:#ffccbc;"></button>
            <button data-color="#c5e1a5" style="background:#c5e1a5;"></button>
            <button data-color="#b3e5fc" style="background:#b3e5fc;"></button>
            <button data-color="#ffcdd2" style="background:#ffcdd2;"></button>
          </div>
          
          <!-- 螢光筆：主按鈕 -->
          <button class="pill" id="bHL">
            <span>螢光筆</span>
            <span>▾</span>
          </button>
          <!-- 自製螢光筆色盤 -->
          <div id="hlPalette" class="color-palette hidden">
            <!-- 第一排：常用亮色 -->
            <button data-color="#fff59d" style="background:#fff59d;"></button>
            <button data-color="#ffcc80" style="background:#ffcc80;"></button>
            <button data-color="#b2ff59" style="background:#b2ff59;"></button>
            <button data-color="#80deea" style="background:#80deea;"></button>
            <button data-color="#ef9a9a" style="background:#ef9a9a;"></button>
          
            <!-- 第二排：稍深一點 -->
            <button data-color="#fff176" style="background:#fff176;"></button>
            <button data-color="#ffb74d" style="background:#ffb74d;"></button>
            <button data-color="#aed581" style="background:#aed581;"></button>
            <button data-color="#4dd0e1" style="background:#4dd0e1;"></button>
            <button data-color="#e57373" style="background:#e57373;"></button>
          
            <!-- 第三排：淡色系 -->
            <button data-color="#fff9c4" style="background:#fff9c4;"></button>
            <button data-color="#ffe0b2" style="background:#ffe0b2;"></button>
            <button data-color="#e6ee9c" style="background:#e6ee9c;"></button>
            <button data-color="#b3e5fc" style="background:#b3e5fc;"></button>
            <button data-color="#ffcdd2" style="background:#ffcdd2;"></button>
          </div>
        
          <!-- 插入圖片 -->
          <input id="imgNote" type="file" accept="image/*" class="hidden">
          <button class="pill" id="bImg">插入圖片</button>

          <button class="pill hidden" id="btnExportNotes">匯出本卷詳解</button>
        </div>

        <div id="editor" class="editor" contenteditable="true" aria-label="這題的筆記…（可調字級、粗體、顏色、螢光筆、插圖）"></div>
        <div class="footer-hint">筆記會自動儲存在瀏覽器（IndexedDB / localStorage）。</div>
      </div>
    </main>

    <!-- 右：選題清單 -->
    <aside class="right panel">
      <div class="q-list" id="qList"></div>
    </aside>
  </div>
    <!-- Firebase CDN：放在 app.js 之前 -->
  <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>

  <script>
    // 這段 firebaseConfig 物件，整個從 Firebase 畫面複製貼上
    const firebaseConfig = {
        apiKey: "AIzaSyCLA65MNmKe0xKNr3j213KpeU5mA4jycKw",
        authDomain: "ntuvmexam-pwa.firebaseapp.com",
        projectId: "ntuvmexam-pwa",
        storageBucket: "ntuvmexam-pwa.firebasestorage.app",
        messagingSenderId: "795891762702",
        appId: "1:795891762702:web:d0038d05d4803971749e5f",
        measurementId: "G-WYE4T2RBXQ"
    };

    // 初始化 Firebase & Firestore（用 compat 版，語法比較簡單）[web:73][web:109]
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
  </script>
  <script src="app.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      // 1) 註冊時關掉 HTTP cache，確保永遠抓到最新的 service-worker.js
      navigator.serviceWorker.register("./service-worker.js", {
        updateViaCache: "none"
      }); // [web:78][web:81][web:98][web:100]
  
      // 2) 當有「新的 SW 接手控制」時，自動重整一次
      let refreshing = false;
      navigator.serviceWorker.addEventListener("controllerchange", () => {
        if (refreshing) return;
        refreshing = true;
        window.location.reload();
      }); // [web:82][web:92][web:94][web:99]
    }
  </script>
</body>
</html>
